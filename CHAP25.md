# study-springboot
React + Spring Boot + DB(H2DB -> Oracle)

## chap25. Spring Boot tutorial

### A. 리액트 프로젝트 생성
0. VS Code, node.js 등은 모두 설치 진행, 반드시 크롬브라우저로 개발할 것!!
	- 플러그 인 : Simple React Snippets 설치
	- 크롬브라우저 : LiveReload++, React 개발자 도구 설치
1. 프로젝트 생성한 폴더 아래와 같이 생성
	- **board-front (프론트엔드 폴더) : npx로 생성**
	- **board-back (백엔드 폴더) : 나중에 생성함**
2. board-front 에서 컨텍스트 메뉴 > 통합 터미널에서 열기 클릭
	```shell
	chap25> node -v # js 실행 명령어 
	chap25> npm -v # Node Package Manager 설치 명령어
	chap25> npx -v # Node Package eXecute 실행 명령어
	```
	- 확인 후 프로젝트 생성 시작
	```shell
	chap25> npx create-react-app board-front
	```

	- 생성 후 서버 실행
	```shell
	> cd board-front
	> npm start
	```

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0401.png" width="500">

	- 실행결과
	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0402.png" width="730">

	- 추가!
		- Chrome 브라우저 > 확장 프로그램 > React Developer Tools 5.x 설치요!

		<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0403.png" width="400">

- 소스 올리기전 주의사항
	- .gitignore에 node 관련 설정 추가할 것

	```dockerfile
	# Logs
	logs
	*.log
	npm-debug.log*
	yarn-debug.log*
	yarn-error.log*
	lerna-debug.log*
	.pnpm-debug.log*

	# Diagnostic reports (https://nodejs.org/api/report.html)
	report.[0-9]*.[0-9]*.[0-9]*.[0-9]*.json

	# Runtime data
	pids
	*.pid
	*.seed
	*.pid.lock

	# Directory for instrumented libs generated by jscoverage/JSCover
	lib-cov

	# Coverage directory used by tools like istanbul
	coverage
	*.lcov

	# nyc test coverage
	.nyc_output

	# Grunt intermediate storage (https://gruntjs.com/creating-plugins#storing-task-files)
	.grunt

	# Bower dependency directory (https://bower.io/)
	bower_components

	# node-waf configuration
	.lock-wscript

	# Compiled binary addons (https://nodejs.org/api/addons.html)
	build/Release

	# Dependency directories
	node_modules/
	jspm_packages/

	# Snowpack dependency directory (https://snowpack.dev/)
	web_modules/

	# TypeScript cache
	*.tsbuildinfo

	# Optional npm cache directory
	.npm

	# Optional eslint cache
	.eslintcache

	# Optional stylelint cache
	.stylelintcache

	# Microbundle cache
	.rpt2_cache/
	.rts2_cache_cjs/
	.rts2_cache_es/
	.rts2_cache_umd/

	# Optional REPL history
	.node_repl_history

	# Output of 'npm pack'
	*.tgz

	# Yarn Integrity file
	.yarn-integrity

	# dotenv environment variable files
	.env
	.env.development.local
	.env.test.local
	.env.production.local
	.env.local

	# parcel-bundler cache (https://parceljs.org/)
	.cache
	.parcel-cache

	# Next.js build output
	.next
	out

	# Nuxt.js build / generate output
	.nuxt
	dist

	# Gatsby files
	.cache/
	# Comment in the public line in if your project uses Gatsby and not Next.js
	# https://nextjs.org/blog/next-9-1#public-directory-support
	# public

	# vuepress build output
	.vuepress/dist

	# vuepress v2.x temp and cache directory
	.temp
	.cache

	# Docusaurus cache and generated files
	.docusaurus

	# Serverless directories
	.serverless/

	# FuseBox cache
	.fusebox/

	# DynamoDB Local files
	.dynamodb/

	# TernJS port file
	.tern-port

	# Stores VSCode versions used for testing VSCode extensions
	.vscode-test

	# yarn v2
	.yarn/cache
	.yarn/unplugged
	.yarn/build-state.yml
	.yarn/install-state.gz
	.pnp.*
	```

	- .gitignore 먼저 github에 업로드 후 나머지 소스 올릴것!!!

### B. 기본 수정 확인
- 기본 폴더 설명 생략
- src/App.js의 아래 코드 수정
	```javascript
	function App() {
		return (
			<div className="App">
			<header className="App-header">
				{/* <img src={logo} className="App-logo" alt="logo" />
				<p>
				Edit <code>src/App.js</code> and save to reload.
				</p>
				<a
				className="App-link"
				href="https://reactjs.org"
				target="_blank"
				rel="noopener noreferrer"
				>
				Learn React
				</a> */}
				<h1>Hello, React.js!!</h1>
			</header>
			</div>
		);
	}
	```

	- 실행결과

		<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0404.png" width="730">

	- 서버종료
	```shell
	> # Ctrl + C
	> 일괄 작업을 끝내시겠습니까 (Y/N)? y
	chap25/board-front> _
	```

## C. Bootstrap 패키지 설치
- Bootstrap 설치 방법 두가지
	1. 일반적인 CDN으로 설치하는 방법
	2. npm 명령어로 추가하는 방법 - https://www.npmjs.com/package/bootstrap 확인

		```shell
		> npm i bootstrap
		```
	
	3. package.json에 설치결과 확인

		<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0405.png" width="730">

- axios 패키지 설치

	```shell
	> npm i axios
	```

- react-router-dom 패키지 설치
	```shell
	> npm i react-router-dom
	```

## D. Back-end 개발설정
- 명령 팔레트 실행(Ctrl + Shift + P)
	1. Spring Initializr: Create a Gradle Project...
	2. Specify Spring Boot version : 3.2.x 이상 선택
	3. Specify project language : Java 
	4. Input Group Id : com.hugo83 등 자신의 도메인으로 입력
	5. Input Artifact Id : board-back 등 자신의 호스트로 입력
	6. Specify packaging type : Jar 선택
	7. Specify Java version : 17 선택
	8. Choose dependencies : Thymeleaf, Spring Web, Lombok, Spring Boot Devtools 다섯 개 선택 (Data JPA, H2 Database, Oracle Driver 등은 차후)

- application.properties 설정

	```properties
	spring.application.name=board-back

	## 포트변경
	server.port=8080

	## 로그 색상
	spring.output.ansi.enabled=always

	## 수정사항 생길시 자동 재빌드를 위한 코드
	spring.devtools.livereload.enabled=true
	spring.devtools.restart.enabled=true

	## 로그레벨 설정
	logging.level.org.springframework=info
	logging.level.org.zerock=debug
	```

- test/BoardBackApplicationTests.java --> jbak으로 변경후 그레이들 빌드
- controller/HelloController.java 생성

## JPA, DB 시작
- build.gradle 추가
	- Database - H2DB(inmemory DB)에 각 다른 DBMS로 이전 쉬움
	- JPA 설정

	```properties
	developmentOnly 'org.springframework.boot:spring-boot-devtools'

	implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'

	compileOnly 'org.projectlombok:lombok'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

	runtimeOnly 'com.h2database:h2'
	//runtimeOnly 'com.oracle.database.jdbc:ojdbc11'
	```
- application.properties 설정
	- Oracle 설정도 주석처리 해서 입력 

	```properties
	## H2 설정
	spring.h2.console.enabled=true
	spring.h2.console.path=/h2-console
	spring.datasource.url=jdbc:h2:~/local
	spring.datasource.driverClassName=org.h2.Driver
	spring.datasource.username=sa
	spring.datasource.password=

	## Oracle 설정
	# spring.datasource.username=sbboard
	# spring.datasource.password=1234
	# spring.datasource.url=jdbc:oracle:thin:@localhost:1521:XE
	# spring.datasource.driver-class-name=oracle.jdbc.OracleDriver

	## JPA설정
	spring.jpa.show-sql=true
	spring.jpa.properties.hibernate.format_sql=true
	## 아래 버전차이로 오류 발생!??
	# spring.jpa.database-platform=org.hibernate.dialect.Oracle12cDialect

	# Database management policies
	# update: create once
	# create: create every time of application up
	# create-drop: create at the start of app and drop before end of app
	spring.jpa.hibernate.ddl-auto=update
	```

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0410.png" width="730">

- H2 콘솔접속
	- http://localhost:8080/h2-console

- spring.jpa.hibernate.ddl-auto의 규칙
	- none: 엔티티가 변경되더라도 데이터베이스 변경 없음
	- update: 엔티티의 변경된 부분만 데이터베이스에 적용
	- validate: 엔티티와 테이블 간에 차이점 검사만 수행
	- create: 서버를 시작할 시 테이블 모두 삭제, 재생성
	- create-drop: create와 동일하지만 서버 종료 시 테이블 모두 삭제

- /entity/Board.java 생성
- /entity/Reply.java 생성
	- Reply에 있는 멤버변수 board의 @ManyToOne은 Board에 많은 댓글이 달릴 수 있다는 의미
	- DB에서 Board테이블과 Reply테이블은 1:N 관계!
	```java
	@ManyToOne
	private Board board;
	```
- /entity/Board.java에 Reply 멤버변수 추가(위의 것 또는 이거 중 하나만!!!)
	```java
	@OneToMany(mappedBy = "Board", cascade = CascadeType.REMOVE)
	private List<Reply> replyList;
	```

- 서버 재실행

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0411.png" width="730">

- /repository/BoardReposity.java 인터페이스 생성
- /repository/ReplyReposity.java 인터페이스 생성

- test/repository/BoardRepositoryTests.java 작성 테스트

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0412.png" width="730">

- 테스트에 조회 작성 테스트

## JPA, Oracle로 변경 테스트(성공!)
- 중요사항!! JPA가 만들어주는 페이징 쿼리가 Oracle 12c 아래버전은 제대로 동작하지 않음.
	- 최소 12c, 그 이상 버전으로 설치할 것!!!
- H2와 변경
	- build.gradle
	```gradle
	//runtimeOnly 'com.h2database:h2'
	runtimeOnly 'com.oracle.database.jdbc:ojdbc11'
	```

	- application.properties
	```properties
	## H2 설정
	# spring.h2.console.enabled=true
	# spring.h2.console.path=/h2-console
	# spring.datasource.url=jdbc:h2:~/local
	# spring.datasource.driverClassName=org.h2.Driver
	# spring.datasource.username=sa
	# spring.datasource.password=

	## Oracle 설정
	spring.datasource.username=sbboard
	spring.datasource.password=1234
	spring.datasource.url=jdbc:oracle:thin:@localhost:1521:XE
	spring.datasource.driver-class-name=oracle.jdbc.OracleDriver

	## H2와 Oracle별 Dialect
	# spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.H2Dialect
	# 중요! Spring Boot 최신 버전에서는 Oracle10gDialect, Oracle12gDialect 등 사용 불가!
	spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.OracleDialect
	```

	- Board.java / Reply.java
		```java
		public class Board {
			@Id
			//@GeneratedValue(strategy = GenerationType.IDENTITY)
			@GeneratedValue(strategy = GenerationType.SEQUENCE) // H2는 IDENTITY/SEQUENCE 모두 가능
			private Long Bno;

			@Column(name = "Title", length = 200)
			private String title;

			// @Column(name="Content", columnDefinition = "TEXT")
			@Column(name="Content")
			private String content;

			// ...
		```

		```java
		public class Reply {
			@Id
			//@GeneratedValue(strategy = GenerationType.IDENTITY)
			@GeneratedValue(strategy = GenerationType.SEQUENCE)
			private Long Rno;

			//@Column(name = "Content", columnDefinition = "TEXT")
			@Column(name = "Content")
			private String content;

			// ...
		```

## 다시 H2DB
- 답변 입력 테스트 확인

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0413.png" width="730">

- build.gradle에 Thymeleaf 라이브러리 추가
- 게시글 목록 
	/controller/BoardController.java 생성

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0414.png" width="730">

- HelloController -> MainController로 변경
	- index() 메서드 추가

### 서비스 활용
- 서비스는 복잡한 코드를 모듈화 할 수 있음
	- 중복된 메서드를 서비스에서 통합 여러 컨트롤러에서 호출해서 사용할 수 있음
- 엔티티 객체를 DTO(Data Transfer Object)로 변환가능
	- 엔티티가 직접 전달되는 것은 보안적으로 데이터 노출에 좋지 않음

- /service/BoardService.java 생성
- /controller/BoardController.java 서비스 추가

- /templates/board/list.html 링크 추가

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0415.png" width="730">

- BoardController.java에 상세페이지 매핑 메서드 detail() 추가
- BoardService.java 상세페이지 메서드 추가
- /common/DataNotFoundException.java 클래스 생성
- detail() 메서드 내 서비스 사용내용 추가

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0416.png" width="730">

- /board/detail.html 에 답변 내용 만들기

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0417.png" width="730">

- /controller/ReplyController.java 작성
- /service/ReplyService.java 작성
- ReplyController.java에 ReplyService 객체 추가

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0418.png" width="730">

- /templates/board/detail.html 에서 답변표시

	- 이전에 Board.java에 replyList 확인!
	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0419.png" width="730">

### 부트스트랩 적용
- 부트스트랩은 다운로드 받아서 static에 넣기, CDN을 추가하는 두 방법 
- bootstrap-5.3.3-dist.zip 다운로드
	- 압축 해제 후 bootstrap.min.css를 static에 위치
	- /board/list.html 에 부트스트랩 적용

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0420.png" width="730">

	- /board/detail.html 에 부트스트랩 적용

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0421.png" width="730">

	- templates/layout.html 작성
	- list.html, detail.html에 layout.html 적용
	- list.html 게시글 버튼 만들기

- BoardController에 boardCreate() 추가
- /board/create.html 작성

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0422.png" width="730">

- BoardService.java 에 저장관련 메서드 추가

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0423.png" width="730">

### 스프링부트 검증 라이브러리 
- build.gradle에 Spring Boot Validation 추가
	```properties
	implementation 'org.springframework.boot:spring-boot-starter-validation'
	```
- 검증확인 : https://beanvalidation.org/
- /validation/BoardForm.java 생성
- 검증클래스 컨트롤러에 전송, public String create() 가 전면 수정됨
- /templates/board/create.html 템플릿 수정

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0424.png" width="730">

- ReplyForm.java 작성
- ReplyController.java 수정
- /board/detail.html 수정
- BoardController.java detail() 메서드 수정

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0425.png" width="730">

- create.html, detail.html에 사용한 오류메시지 부분 공통템플릿으로 만들기
- 기존 화면에 적용

### 내비게이션바 추가
- layout.html 템플릿에 내비케이션 바 추가

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0426.png" width="730">

- bootstrap.min.js 를 static 폴더에 옮기기
- layout.html 템플릿 소스 맨아래 부트스트랩 자바스크립트 소스 추가
- navbar.html에 내비게이션바 분리하기

### 페이징 추가
- 대량데이터 출력시 불편함 해소
- /test/.../service/BoardServiceTests.java 작성, 대량데이터 테스트 생성 및 실행

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0427.png" width="730">

- 페이징처리에 필요한 요소
	- org.springframework.data.domain.Page: 페이징을 위한 클래스
	- org.springframework.data.domain.PageRequest: 현재 페이지와 한 페이지에 보여 줄 게시물 개수 등을 설정, 페이징 요청
	- org.springframework.data.domain.Pageable: 페이징을 처리하는 인터페이스

- /repository/BoardRepository.java 인터페이스에 페이징용 추가메서드 작성
- /service/BoardService.java에 페이징 관련 추가
- /controller/BoardController.java 수정
- /board/list.html 변경
- http://localhost:8080/board/list?page=1 로 페이지 요청

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0428.png" width="730">

- /board/list.html에 페이지 이동 기능 추가 및 완성

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0429.png" width="730">

- /service/BoardSerivce.java 최신순으로 데이터 조회 변경

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0430.png" width="730">

- /board/list.html에 댓글 개수 표시하기

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0431.png" width="730">

### 로그인 처리
- build.gradle에 스프링 시큐리티 설치
	```gradle
	implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'
	```
- 재시작 후 http://localhost:8080/board/list?page=0 등을 입력하면 로그인화면으로 이동

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0432.png" width="730">

	- http://localhost:8080/logout 실행 테스트

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0436.png" width="730">

- /config/SecurityConfig.java 작성
	- CSRF 토큰으로 토큰이 없으면 스프링 시큐리티 차단함
	- 모든 영역에서 그냥 볼 수 있도록 처리
	- 단, H2 DB를 사용할 때 403(권한없음) 문제 발생. 문제 발생하지 않도록 SecurityConfig 수정

- 회원가입 기능 구현
	- SiteUser.java 회원 엔티티 생성

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0433.png" width="730">

- UserController.java 중복회원 가입 방지 추가

- /repository/UserRepository.java 작성
- /service/UserService.java 작성
- /validation/UserForm.java 작성
- /controller/UserController.java 작성
- /templates/user/signup.html 작성
- 내비게이션 바에 회원가입 링크 추가

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0434.png" width="730">

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0435.png" width="730">

- 로그인/로그아웃 구현
	- SecurityConfig.java에 로그인 URL 등록
	- UserController에 로그인 URL 매핑 추가
	- 로그인 템플릿 작성하기
	- UserRepository에 Email로 사용자찾기 메서드 추가
	- /role/UserRole.java enum 생성
	- /service/UserSecurityService.java 생성
	- SecurityConfig.java에 AuthenticationManager 빈 추가
	- 로그인 화면 수정
	- 로그아웃 기능 구현

- /entity/Board.java와 Reply.java에 author 속성 추가하기
- /controller/ReplyController.java에 수정
- /service/UserService.java 에 getUser() 구현
- ReplyController.java에 UserService 추가

- /service/BoardService.java 에 SiteUser 추가
- /controller/BoardController.java에 UserService 추가
- 로그아웃 후 질문 또는 답변 등록하면 내부서버오류(500) 발생
- BoardController.java와 ReplyController.java에 @PreAuthorize("isAuthenticated()") 추가
- SecurityConfig.java 에 @EnableMethodSecurity 어노테이션 추가

- /board/detail.html에 로그아웃시 답변 작성 못하도록 변경
- 글쓴이 추가

## 수정 삭제 등 추가기능 완료
- 게시글 수정/삭제 기능
	- /entity/Reply.java에 수정일차 추가
	- /board/detail.html 에 질문 수정버튼 생성
	- BoardController.java 수정
	- /board/create.html 템플릿 수정에서도 쓰도록 변경
		- th:action="@{/board/create}" 반드시 삭제해야 함!!
	- BoardService.java에서 수정 메서드 추가
	- BoardController.java에 수정 Post메서드 추가

	- /board/detail.html 에 삭제 버튼 추가
	- layout.html 에 스크립트 템플릿 추가
	- 삭제를 위한 자바스크립트 추가

		<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0438.png" width="730">

	- BoardService.java 수정
	- BoardController.java 삭제 메서드 추가

- 댓글 수정기능 추가
	- /board/detail.html 에 댓글 수정 버튼 추가
	- /service/ReplyService.java 에 메서드 추가
	- /controller/ReplyController.java 에 답변 Get 메서드 추가
	- /templates/reply/modify.html 작성
	- /controller/ReplyController.java에 재수정 Post 메서드 추가
- 댓글 삭제기능 추가
	- /templates/board/detail.html 댓글 삭제버튼 추가
	- /service/ReplyService.java 에 삭제 메서드 추가
	- /controller.ReplyController.java 삭제 메서드 
	
	- /templates/board/detail.html에 수정일시 표시

	<img src="https://raw.githubusercontent.com/hugoMGSung/study-springboot/main/images/sb0439.png" width="730">

## 추천기능 부터...